<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Tutorial 3: Survival Analysis through R</title>
    <meta charset="utf-8" />
    <meta name="author" content="Miss. Na Zhao" />
    <link href="libs/remark-css/default.css" rel="stylesheet" />
    <link href="libs/remark-css/default-fonts.css" rel="stylesheet" />
    <link href="libs/remark-css/duke-blue.css" rel="stylesheet" />
    <link href="libs/remark-css/hygge-duke.css" rel="stylesheet" />
    <link rel="stylesheet" href="libs/cc-fonts.css" type="text/css" />
    <link rel="stylesheet" href="libs/figure-captions.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Tutorial 3: Survival Analysis through R
### Miss. Na Zhao

---



# Outline

- Survival Object 
  
- Kaplan-Meier Survival Function
  
- Cox Model
  
- RMST Model


---

# Survival Object
Basically observed data in survival analysis is consist of the minimum of survival time and censored time, and one indicator indicating if the observed time is censored or not. 



```r
# Install the package "survival" in R
# Import the lung cancer dataset and have a look at it
library(survival)
attach(lung)
head(lung)
```

```
##   inst time status age sex ph.ecog ph.karno pat.karno meal.cal wt.loss
## 1    3  306      2  74   1       1       90       100     1175      NA
## 2    3  455      2  68   1       0       90        90     1225      15
## 3    3 1010      1  56   1       0       90        90       NA      15
## 4    5  210      2  57   1       1       90        60     1150      11
## 5    1  883      2  60   1       0      100        90       NA       0
## 6   12 1022      1  74   1       1       50        80      513       0
```
- by help(lung) to see detail of lung dataset
- time: survival time
- status: censoring status 1=censored, 2=dead

---
# Survival Object

```r
#re-order the data by survial time
library(dplyr)
head(arrange(lung, time)) # by default ascending
```

```
##     inst time status age sex ph.ecog ph.karno pat.karno meal.cal wt.loss
## 57     5    5      2  65   2       0      100        80      338       5
## 73     5   11      2  74   1       2       70       100     1175       0
## 79     3   11      2  81   1       0       90        NA      731      15
## 108    1   11      2  67   1       1       90        90      925      NA
## 30     1   12      2  74   1       2       70        50      305      20
## 116    1   13      2  76   1       2       70        70      413      20
```


---
# Survival Object
In R, We need to generate new survival object by function `\(Surv()\)` in "survival" package for further manipulation.

```r
# Surv(time, event) creates a survival object for right censored data.
# "time" is the follow up time.
# "event" indicator, normally 0=alive (censored), 1=dead or 1/2 .
Lungsur=Surv(time,status)
head(Lungsur)
```

```
## [1]  306   455  1010+  210   883  1022+
```

```r
# pay attention to the meaning of event argument in Surv()
# what if status==1 stands for dead?
Lungsur2=Surv(time,status==1)
head(Lungsur2)
```

```
## [1]  306+  455+ 1010   210+  883+ 1022
```

---
# Kaplan-Meier Survival Function
## overall survival curve 
- `\(survfit(formula,...)\)` function creates survival curves.
- `\(formula\)` should have the form `\("Surv\ object \sim term1+...+term k"\)`.
- with term 1, creates the single curve of K-M estimate.

```r
fit1=survfit(Lungsur~1,data=lung) 
summary(fit1)
```

```
## Call: survfit(formula = Lungsur ~ 1, data = lung)
## 
##  time n.risk n.event survival std.err lower 95% CI upper 95% CI
##     5    228       1   0.9956 0.00438       0.9871        1.000
##    11    227       3   0.9825 0.00869       0.9656        1.000
##    12    224       1   0.9781 0.00970       0.9592        0.997
##    13    223       2   0.9693 0.01142       0.9472        0.992
##    15    221       1   0.9649 0.01219       0.9413        0.989
##    26    220       1   0.9605 0.01290       0.9356        0.986
##    30    219       1   0.9561 0.01356       0.9299        0.983
##    31    218       1   0.9518 0.01419       0.9243        0.980
##    53    217       2   0.9430 0.01536       0.9134        0.974
##    54    215       1   0.9386 0.01590       0.9079        0.970
##    59    214       1   0.9342 0.01642       0.9026        0.967
##    60    213       2   0.9254 0.01740       0.8920        0.960
##    61    211       1   0.9211 0.01786       0.8867        0.957
##    62    210       1   0.9167 0.01830       0.8815        0.953
##    65    209       2   0.9079 0.01915       0.8711        0.946
##    71    207       1   0.9035 0.01955       0.8660        0.943
##    79    206       1   0.8991 0.01995       0.8609        0.939
##    81    205       2   0.8904 0.02069       0.8507        0.932
##    88    203       2   0.8816 0.02140       0.8406        0.925
##    92    201       1   0.8772 0.02174       0.8356        0.921
##    93    199       1   0.8728 0.02207       0.8306        0.917
##    95    198       2   0.8640 0.02271       0.8206        0.910
##   105    196       1   0.8596 0.02302       0.8156        0.906
##   107    194       2   0.8507 0.02362       0.8056        0.898
##   110    192       1   0.8463 0.02391       0.8007        0.894
##   116    191       1   0.8418 0.02419       0.7957        0.891
##   118    190       1   0.8374 0.02446       0.7908        0.887
##   122    189       1   0.8330 0.02473       0.7859        0.883
##   131    188       1   0.8285 0.02500       0.7810        0.879
##   132    187       2   0.8197 0.02550       0.7712        0.871
##   135    185       1   0.8153 0.02575       0.7663        0.867
##   142    184       1   0.8108 0.02598       0.7615        0.863
##   144    183       1   0.8064 0.02622       0.7566        0.859
##   145    182       2   0.7975 0.02667       0.7469        0.852
##   147    180       1   0.7931 0.02688       0.7421        0.848
##   153    179       1   0.7887 0.02710       0.7373        0.844
##   156    178       2   0.7798 0.02751       0.7277        0.836
##   163    176       3   0.7665 0.02809       0.7134        0.824
##   166    173       2   0.7577 0.02845       0.7039        0.816
##   167    171       1   0.7532 0.02863       0.6991        0.811
##   170    170       1   0.7488 0.02880       0.6944        0.807
##   175    167       1   0.7443 0.02898       0.6896        0.803
##   176    165       1   0.7398 0.02915       0.6848        0.799
##   177    164       1   0.7353 0.02932       0.6800        0.795
##   179    162       2   0.7262 0.02965       0.6704        0.787
##   180    160       1   0.7217 0.02981       0.6655        0.783
##   181    159       2   0.7126 0.03012       0.6559        0.774
##   182    157       1   0.7081 0.03027       0.6511        0.770
##   183    156       1   0.7035 0.03041       0.6464        0.766
##   186    154       1   0.6989 0.03056       0.6416        0.761
##   189    152       1   0.6943 0.03070       0.6367        0.757
##   194    149       1   0.6897 0.03085       0.6318        0.753
##   197    147       1   0.6850 0.03099       0.6269        0.749
##   199    145       1   0.6803 0.03113       0.6219        0.744
##   201    144       2   0.6708 0.03141       0.6120        0.735
##   202    142       1   0.6661 0.03154       0.6071        0.731
##   207    139       1   0.6613 0.03168       0.6020        0.726
##   208    138       1   0.6565 0.03181       0.5970        0.722
##   210    137       1   0.6517 0.03194       0.5920        0.717
##   212    135       1   0.6469 0.03206       0.5870        0.713
##   218    134       1   0.6421 0.03218       0.5820        0.708
##   222    132       1   0.6372 0.03231       0.5769        0.704
##   223    130       1   0.6323 0.03243       0.5718        0.699
##   226    126       1   0.6273 0.03256       0.5666        0.694
##   229    125       1   0.6223 0.03268       0.5614        0.690
##   230    124       1   0.6172 0.03280       0.5562        0.685
##   239    121       2   0.6070 0.03304       0.5456        0.675
##   245    117       1   0.6019 0.03316       0.5402        0.670
##   246    116       1   0.5967 0.03328       0.5349        0.666
##   267    112       1   0.5913 0.03341       0.5294        0.661
##   268    111       1   0.5860 0.03353       0.5239        0.656
##   269    110       1   0.5807 0.03364       0.5184        0.651
##   270    108       1   0.5753 0.03376       0.5128        0.645
##   283    104       1   0.5698 0.03388       0.5071        0.640
##   284    103       1   0.5642 0.03400       0.5014        0.635
##   285    101       2   0.5531 0.03424       0.4899        0.624
##   286     99       1   0.5475 0.03434       0.4841        0.619
##   288     98       1   0.5419 0.03444       0.4784        0.614
##   291     97       1   0.5363 0.03454       0.4727        0.608
##   293     94       1   0.5306 0.03464       0.4669        0.603
##   301     91       1   0.5248 0.03475       0.4609        0.597
##   303     89       1   0.5189 0.03485       0.4549        0.592
##   305     87       1   0.5129 0.03496       0.4488        0.586
##   306     86       1   0.5070 0.03506       0.4427        0.581
##   310     85       2   0.4950 0.03523       0.4306        0.569
##   320     82       1   0.4890 0.03532       0.4244        0.563
##   329     81       1   0.4830 0.03539       0.4183        0.558
##   337     79       1   0.4768 0.03547       0.4121        0.552
##   340     78       1   0.4707 0.03554       0.4060        0.546
##   345     77       1   0.4646 0.03560       0.3998        0.540
##   348     76       1   0.4585 0.03565       0.3937        0.534
##   350     75       1   0.4524 0.03569       0.3876        0.528
##   351     74       1   0.4463 0.03573       0.3815        0.522
##   353     73       2   0.4340 0.03578       0.3693        0.510
##   361     70       1   0.4278 0.03581       0.3631        0.504
##   363     69       2   0.4154 0.03583       0.3508        0.492
##   364     67       1   0.4092 0.03582       0.3447        0.486
##   371     65       2   0.3966 0.03581       0.3323        0.473
##   387     60       1   0.3900 0.03582       0.3258        0.467
##   390     59       1   0.3834 0.03582       0.3193        0.460
##   394     58       1   0.3768 0.03580       0.3128        0.454
##   426     55       1   0.3700 0.03580       0.3060        0.447
##   428     54       1   0.3631 0.03579       0.2993        0.440
##   429     53       1   0.3563 0.03576       0.2926        0.434
##   433     52       1   0.3494 0.03573       0.2860        0.427
##   442     51       1   0.3426 0.03568       0.2793        0.420
##   444     50       1   0.3357 0.03561       0.2727        0.413
##   450     48       1   0.3287 0.03555       0.2659        0.406
##   455     47       1   0.3217 0.03548       0.2592        0.399
##   457     46       1   0.3147 0.03539       0.2525        0.392
##   460     44       1   0.3076 0.03530       0.2456        0.385
##   473     43       1   0.3004 0.03520       0.2388        0.378
##   477     42       1   0.2933 0.03508       0.2320        0.371
##   519     39       1   0.2857 0.03498       0.2248        0.363
##   520     38       1   0.2782 0.03485       0.2177        0.356
##   524     37       2   0.2632 0.03455       0.2035        0.340
##   533     34       1   0.2554 0.03439       0.1962        0.333
##   550     32       1   0.2475 0.03423       0.1887        0.325
##   558     30       1   0.2392 0.03407       0.1810        0.316
##   567     28       1   0.2307 0.03391       0.1729        0.308
##   574     27       1   0.2221 0.03371       0.1650        0.299
##   583     26       1   0.2136 0.03348       0.1571        0.290
##   613     24       1   0.2047 0.03325       0.1489        0.281
##   624     23       1   0.1958 0.03297       0.1407        0.272
##   641     22       1   0.1869 0.03265       0.1327        0.263
##   643     21       1   0.1780 0.03229       0.1247        0.254
##   654     20       1   0.1691 0.03188       0.1169        0.245
##   655     19       1   0.1602 0.03142       0.1091        0.235
##   687     18       1   0.1513 0.03090       0.1014        0.226
##   689     17       1   0.1424 0.03034       0.0938        0.216
##   705     16       1   0.1335 0.02972       0.0863        0.207
##   707     15       1   0.1246 0.02904       0.0789        0.197
##   728     14       1   0.1157 0.02830       0.0716        0.187
##   731     13       1   0.1068 0.02749       0.0645        0.177
##   735     12       1   0.0979 0.02660       0.0575        0.167
##   765     10       1   0.0881 0.02568       0.0498        0.156
##   791      9       1   0.0783 0.02462       0.0423        0.145
##   814      7       1   0.0671 0.02351       0.0338        0.133
##   883      4       1   0.0503 0.02285       0.0207        0.123
```

---
# Kaplan-Meier Survival Function
## overall survival curve 
- You may try to rebuild the K-M estimate as example in p20.
- Construct the same tabel as below, compare it with the previous one.

&lt;figure&gt;
  &lt;img src="km.png",width=0.5&gt;
&lt;/figure&gt;


---
# Kaplan-Meier Survival Function
## overall survival curve 
- You can choose to plot the confident interval or not. 
.pull-left[

```r
plot(fit1,conf.int = FALSE,
       xlab = "Days", 
    ylab = "Overall survival probability")
title("Survival func of Lung cancer study")
```

![](T3_files/figure-html/unnamed-chunk-5-1.png)&lt;!-- --&gt;
]
.pull-left[

```r
plot(fit1,conf.int = TRUE,
    xlab = "Days", 
    ylab = "Overall survival probability",
     conf.type = "log")
title("Survival func of Lung cancer study")
```

![](T3_files/figure-html/unnamed-chunk-6-1.png)&lt;!-- --&gt;
]

---
# Kaplan-Meier Survival Function
## overall survival curve 
- `\(conf.type\)` chooses the way how we derive the variance.
- `\(log\)` is the default method, which corresponds to the Greenwood formula.
- Big criticism of Greenwood: can not guarantee the reasonable range of survival function.
- Complimentary log-log transformation can fix this problem.
- The result will be close when sample size is large enough, all based on Delta Method.


.pull-left[
&lt;figure&gt;
  &lt;img src="greenwood.png"&gt;
&lt;/figure&gt;
]
.pull-right[
&lt;figure&gt;
  &lt;img src="sd.png"&gt;
&lt;/figure&gt;
]




---
# Kaplan-Meier Survival Function
## overall survival curve 
- Alternatively, `\(ggsurvplot\)` function from the `\(survminer\)` package is built on `\(ggplot2\)`.

```r
library(survminer)
ggsurvplot(fit1,data=lung, 
           risk.table = TRUE, # show risk table.
           xlab = "Days",ylab = "Overall survival probability")
```

![](T3_files/figure-html/unnamed-chunk-7-1.png)&lt;!-- --&gt;

---
# Kaplan-Meier Survival Function
## overall survival curve 
- Add more information, like median survival time

```r
ggsurvplot(fit1,  data = lung,             
          risk.table = TRUE,       
          surv.median.line = "hv",  # add the median survival pointer.
        xlab = "Days",ylab = "Overall survival probability")
```

![](T3_files/figure-html/unnamed-chunk-8-1.png)&lt;!-- --&gt;



---
# Kaplan-Meier Survival Function
## stratified survival curve 
- If we want to estimate survival curve for groups.
- You can utilize the `\(dplyr\)` package in T2 to select target group and calculate
survival function separately.
- Or, directly fitting the curve by some strata variable.

```r
fit2=survfit(Lungsur~sex,data=lung) 
summary(fit2)
```
&lt;figure&gt;
  &lt;img src="sex1.png",width="200",height="100"&gt;
&lt;/figure&gt;

&lt;figure&gt;
  &lt;img src="sex2.png",width="300",height="200"&gt;
&lt;/figure&gt;

---
# Kaplan-Meier Survival Function
### stratified survival curve


```r
ggsurvplot(fit2, data = lung, 
           pval = TRUE, #Add p-value
           conf.int = T,
           risk.table = TRUE,        # Add risk table
           xlab = "Days",ylab = "Survival probability",
           legend.labs = c("Male", "Female"),   # Change legend labels
           risk.table.height = 0.25, # Useful to change when you have multiple groups
           surv.median.line = "hv",  # add the median survival pointer.
           ggtheme = theme_bw()      # Change ggplot2 theme
  )
```

![](T3_files/figure-html/unnamed-chunk-10-1.png)&lt;!-- --&gt;

---
# Kaplan-Meier Survival Function
### stratified survival curve
- In two sample comparison problem, we can also conduct 
test through `\(survdiff\)` function. 
- `\(rho\)` stands for different weighted test.

```r
fit3=survdiff(Lungsur~sex,data=lung,
              rho=0 #log-rank test
              ) 
# log-rank test is default, same as in ggsurvplot.
fit3
```
&lt;figure&gt;
  &lt;img src="survdiff.png",width=20%&gt;
&lt;/figure&gt;


---
# Cox model
- To quantify an effect size for a single variable.
- Or include more than one variable into a regression model to account for the effects of multiple variables.
- `\(coxph\)` to fit a Cox proportional hazards regression model.
- Take gender into the Cox model, coefficient is negative, indicates that
 Female has higher survival probability compared to Male significantly.

```r
fit4=coxph(Lungsur ~ sex, data = lung)
fit4
```

```
## Call:
## coxph(formula = Lungsur ~ sex, data = lung)
## 
##        coef exp(coef) se(coef)      z       p
## sex -0.5310    0.5880   0.1672 -3.176 0.00149
## 
## Likelihood ratio test=10.63  on 1 df, p=0.001111
## n= 228, number of events= 165
```

---
# Cox model
- However, is really the cox model valid for lung cancer data?
- Two group tail crosses, the proportional hr assumption is likely to be wrong.
- `\(cox.zph\)` tests the constantancy by weighted residuals.

```r
coxtest=cox.zph(fit4)
print(coxtest)
```

```
##        chisq df     p
## sex     2.86  1 0.091
## GLOBAL  2.86  1 0.091
```

```r
plot(coxtest,xlab = "Days",ylab="Beta(t)")
```

![](T3_files/figure-html/unnamed-chunk-13-1.png)&lt;!-- --&gt;


---
# Cox model
### A forest plot for hazard ratio.
- `\(ggforest\)` to draw forest plot for Cox model.
- More direct illustration.

```r
# Adding age into the cox model.
fit4_s=coxph(Lungsur ~ sex+age, data = lung)
ggforest(fit4_s)
```

![](T3_files/figure-html/unnamed-chunk-14-1.png)&lt;!-- --&gt;

---
# RMST model
- No need for strong model assumption, Model-free and clinically interpretable.
- `\(rmst2\)` function, shoud be careful to each argument definition.

```r
library(survRM2)
arm = as.numeric(factor(sex))-1 # 0 for Male and 1 for Female
fit5=rmst2(time, status-1, arm)
fit5
```
&lt;figure&gt;
  &lt;img src="rmst.png", width="600",height="500"&gt;
&lt;/figure&gt;

---
# RMST model
- `\(tau\)` can be taken at any time smaller than the minimum of the 
largest observed event time on each of the two groups.

```r
fit5_s=rmst2(time, status-1, arm,tau=500)
fit5_s
```
&lt;figure&gt;
  &lt;img src="rmst2.png", width="500",height="400"&gt;
&lt;/figure&gt;



---
# RMST model
- Adding covariates into model, eg: age.

```r
fit6=rmst2(time, status-1, arm,covariates = age)
fit6
```
&lt;figure&gt;
  &lt;img src="rmstage.png",width="300",height="200"&gt;
&lt;/figure&gt;
  
---
# RMST model
- plot RMST curve 

```r
plot(fit5,
     col.RMST = "pink",
     col.RMTL = "gray",
     xlab = "Days",ylab = "Overall survival probability")
```

![](T3_files/figure-html/unnamed-chunk-18-1.png)&lt;!-- --&gt;

---
class: center, middle 
# Q&amp;A
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
